on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+


name: Deploy to Amazon ECR in the dev environment
permissions:
  id-token: write
  contents: read
  packages: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    env:
      working-directory: ./packages/nocodb

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Use Node.js 16
      uses: actions/setup-node@v3
      with:
        node-version: 16.15.0

    # - uses: bahmutov/npm-install@v1
    #   with:
    #     working-directory: ${{ env.working-directory }}

    - name: Build nocodb and docker files
      shell: bash
      run: |
        cd ../..
        npm install
        npm run install:common
        npm run build:common
        cd packages/nocodb-sdk
        npm install && npm run build
        cd ../nc-gui
        npm install && npm run build:copy
        cd ../nocodb
        npm run build
        npm run docker:build
        docker build -t "${{ github.ref_name }}" -f ./Dockerfile .
      working-directory: ${{ env.working-directory }}

    - name: push ecr
      uses: Deep-Consulting-Solutions/ecr-deploy-action@main
      with:
        service-key: 'nocodb' 
        account: ${{ secrets.DCS_AWS_ACCOUNT }}
        source-image: ${{ github.ref_name }}
        tag: ${{ github.ref_name }}
